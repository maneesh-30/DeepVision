<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>NutriComply Generator Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#12af83", "background-light": "#f6f8f7", "background-dark": "#11211d" },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                    borderRadius: { "DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* ── Full-page Hourglass Loading Overlay ── */
        #loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1.5rem;
        }

        #loading-overlay.active {
            display: flex;
        }

        .loader-text {
            color: #ffffff;
            font-size: 1.15rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            animation: pulse-text 2s ease-in-out infinite;
        }

        .loader-subtext {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            font-weight: 500;
        }

        @keyframes pulse-text {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }
        }

        /* ── Hourglass SVG Loader ── */
        .loader {
            --dur: 2s;
            --hue: 155;
            display: block;
            width: 7em;
            height: auto;
        }

        .loader__glare-top,
        .loader__glare-bottom,
        .loader__model,
        .loader__motion-thick,
        .loader__motion-medium,
        .loader__motion-thin,
        .loader__sand-drop,
        .loader__sand-fill,
        .loader__sand-grain-left,
        .loader__sand-grain-right,
        .loader__sand-line-left,
        .loader__sand-line-right,
        .loader__sand-mound-top,
        .loader__sand-mound-bottom {
            animation-duration: var(--dur);
            animation-timing-function: cubic-bezier(0.83, 0, 0.17, 1);
            animation-iteration-count: infinite;
        }

        .loader__glare-top {
            animation-name: glare-top;
        }

        .loader__glare-bottom {
            animation-name: glare-bottom;
        }

        .loader__model {
            animation-name: loader-flip;
            transform-origin: 12.25px 16.75px;
        }

        .loader__motion-thick,
        .loader__motion-medium,
        .loader__motion-thin {
            transform-origin: 26px 26px;
        }

        .loader__motion-thick {
            animation-name: motion-thick;
        }

        .loader__motion-medium {
            animation-name: motion-medium;
        }

        .loader__motion-thin {
            animation-name: motion-thin;
        }

        .loader__sand-drop {
            animation-name: sand-drop;
        }

        .loader__sand-fill {
            animation-name: sand-fill;
        }

        .loader__sand-grain-left {
            animation-name: sand-grain-left;
        }

        .loader__sand-grain-right {
            animation-name: sand-grain-right;
        }

        .loader__sand-line-left {
            animation-name: sand-line-left;
        }

        .loader__sand-line-right {
            animation-name: sand-line-right;
        }

        .loader__sand-mound-top {
            animation-name: sand-mound-top;
        }

        .loader__sand-mound-bottom {
            animation-name: sand-mound-bottom;
            transform-origin: 12.25px 31.5px;
        }

        @keyframes loader-flip {
            from {
                transform: translate(13.75px, 9.25px) rotate(-180deg);
            }

            24%,
            to {
                transform: translate(13.75px, 9.25px) rotate(0);
            }
        }

        @keyframes glare-top {
            from {
                stroke: rgba(255, 255, 255, 0);
            }

            24%,
            to {
                stroke: white;
            }
        }

        @keyframes glare-bottom {
            from {
                stroke: white;
            }

            24%,
            to {
                stroke: rgba(255, 255, 255, 0);
            }
        }

        @keyframes motion-thick {
            from {
                animation-timing-function: cubic-bezier(0.33, 0, 0.67, 0);
                stroke: rgba(255, 255, 255, 0);
                stroke-dashoffset: 153.94;
                transform: rotate(0.67turn);
            }

            20% {
                animation-timing-function: cubic-bezier(0.33, 1, 0.67, 1);
                stroke: rgba(255, 255, 255, 0.6);
                stroke-dashoffset: 141.11;
                transform: rotate(1turn);
            }

            40%,
            to {
                stroke: rgba(255, 255, 255, 0);
                stroke-dashoffset: 153.94;
                transform: rotate(1.33turn);
            }
        }

        @keyframes motion-medium {

            from,
            8% {
                animation-timing-function: cubic-bezier(0.33, 0, 0.67, 0);
                stroke: rgba(255, 255, 255, 0);
                stroke-dashoffset: 153.94;
                transform: rotate(0.5turn);
            }

            20% {
                animation-timing-function: cubic-bezier(0.33, 1, 0.67, 1);
                stroke: white;
                stroke-dashoffset: 147.53;
                transform: rotate(0.83turn);
            }

            32%,
            to {
                stroke: rgba(255, 255, 255, 0);
                stroke-dashoffset: 153.94;
                transform: rotate(1.17turn);
            }
        }

        @keyframes motion-thin {

            from,
            4% {
                animation-timing-function: cubic-bezier(0.33, 0, 0.67, 0);
                stroke: rgba(255, 255, 255, 0);
                stroke-dashoffset: 153.94;
                transform: rotate(0.33turn);
            }

            24% {
                animation-timing-function: cubic-bezier(0.33, 1, 0.67, 1);
                stroke: rgba(255, 255, 255, 0.4);
                stroke-dashoffset: 134.7;
                transform: rotate(0.67turn);
            }

            44%,
            to {
                stroke: rgba(255, 255, 255, 0);
                stroke-dashoffset: 153.94;
                transform: rotate(1turn);
            }
        }

        @keyframes sand-drop {

            from,
            10% {
                animation-timing-function: cubic-bezier(0.12, 0, 0.39, 0);
                stroke-dashoffset: 1;
            }

            70%,
            to {
                stroke-dashoffset: -107;
            }
        }

        @keyframes sand-fill {

            from,
            10% {
                animation-timing-function: cubic-bezier(0.12, 0, 0.39, 0);
                stroke-dashoffset: 55;
            }

            70%,
            to {
                stroke-dashoffset: -54;
            }
        }

        @keyframes sand-grain-left {

            from,
            10% {
                animation-timing-function: cubic-bezier(0.12, 0, 0.39, 0);
                stroke-dashoffset: 29;
            }

            70%,
            to {
                stroke-dashoffset: -22;
            }
        }

        @keyframes sand-grain-right {

            from,
            10% {
                animation-timing-function: cubic-bezier(0.12, 0, 0.39, 0);
                stroke-dashoffset: 27;
            }

            70%,
            to {
                stroke-dashoffset: -24;
            }
        }

        @keyframes sand-line-left {

            from,
            10% {
                animation-timing-function: cubic-bezier(0.12, 0, 0.39, 0);
                stroke-dashoffset: 53;
            }

            70%,
            to {
                stroke-dashoffset: -55;
            }
        }

        @keyframes sand-line-right {

            from,
            10% {
                animation-timing-function: cubic-bezier(0.12, 0, 0.39, 0);
                stroke-dashoffset: 14;
            }

            70%,
            to {
                stroke-dashoffset: -24.5;
            }
        }

        @keyframes sand-mound-top {

            from,
            10% {
                animation-timing-function: linear;
                transform: translate(0, 0);
            }

            15% {
                animation-timing-function: cubic-bezier(0.12, 0, 0.39, 0);
                transform: translate(0, 1.5px);
            }

            51%,
            to {
                transform: translate(0, 13px);
            }
        }

        @keyframes sand-mound-bottom {

            from,
            31% {
                animation-timing-function: cubic-bezier(0.61, 1, 0.88, 1);
                transform: scale(1, 0);
            }

            56%,
            to {
                transform: scale(1, 1);
            }
        }

        /* ── Other Styles ── */
        .high-sodium {
            display: none;
            background: #dc2626;
            color: white;
            font-weight: 900;
            text-align: center;
            padding: 6px;
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 8px;
        }

        .high-sodium.visible {
            display: block;
        }

        .veg-icon {
            width: 20px;
            height: 20px;
            border: 2px solid #16a34a;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .veg-icon::after {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #16a34a;
        }

        .veg-icon.non-veg-icon {
            border-color: #dc2626;
        }

        .veg-icon.non-veg-icon::after {
            background: #dc2626;
            border-radius: 0;
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
        }
    </style>

    <script>
        async function generateLabel(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const btn = document.getElementById('submitBtn');
            const overlay = document.getElementById('loading-overlay');
            const errorBox = document.getElementById('error-message');

            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span> Generating...';
            overlay.classList.add('active');
            errorBox.style.display = 'none';

            // Validate FSSAI license
            const licenseInput = document.getElementById('fssai_license');
            if (licenseInput) {
                const licenseVal = licenseInput.value.trim();
                if (licenseVal && !/^[0-9]{14}$/.test(licenseVal)) {
                    errorBox.textContent = "FSSAI License Number must be exactly 14 digits if provided.";
                    errorBox.style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-outlined">auto_awesome</span> Generate Nutrition Label';
                    overlay.classList.remove('active');
                    return;
                }
            }

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    body: formData,
                    headers: { 'Accept': 'application/json' }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate label');
                }

                document.getElementById('res-servings').textContent = data.servings_per_pack;
                document.getElementById('res-size').textContent = data.serving_size_g;
                document.getElementById('val-en-100').textContent = data.per_100g.energy.toFixed(1);
                document.getElementById('val-en-serv').textContent = data.per_serving.energy.toFixed(1);
                document.getElementById('val-pro-100').textContent = data.per_100g.protein;
                document.getElementById('val-pro-serv').textContent = data.per_serving.protein;
                document.getElementById('val-fat-100').textContent = data.per_100g.fat;
                document.getElementById('val-fat-serv').textContent = data.per_serving.fat;
                document.getElementById('val-sat-100').textContent = data.per_100g.sat_fat;
                document.getElementById('val-sat-serv').textContent = data.per_serving.sat_fat;
                document.getElementById('val-trans-100').textContent = data.per_100g.trans_fat;
                document.getElementById('val-trans-serv').textContent = data.per_serving.trans_fat;
                document.getElementById('val-carb-100').textContent = data.per_100g.carbs;
                document.getElementById('val-carb-serv').textContent = data.per_serving.carbs;
                document.getElementById('val-sug-100').textContent = data.per_100g.sugar;
                document.getElementById('val-sug-serv').textContent = data.per_serving.sugar;
                document.getElementById('val-addsug-100').textContent = data.per_100g.added_sugar;
                document.getElementById('val-addsug-serv').textContent = data.per_serving.added_sugar;
                document.getElementById('val-sod-100').textContent = data.per_100g.sodium;
                document.getElementById('val-sod-serv').textContent = data.per_serving.sodium;

                const vegIcon = document.getElementById('veg-icon');
                const vegText = document.getElementById('veg-text');
                if (data.veg_type === 'non-veg') {
                    vegIcon.className = 'veg-icon non-veg-icon';
                    vegText.textContent = 'Non-Vegetarian';
                } else {
                    vegIcon.className = 'veg-icon';
                    vegText.textContent = 'Vegetarian';
                }

                document.getElementById('res-allergen').textContent = data.allergen_statement;

                const sodiumBanner = document.getElementById('sodium-warning');
                if (data.sodium_warning) { sodiumBanner.classList.add('visible'); }
                else { sodiumBanner.classList.remove('visible'); }

                document.getElementById('download-pdf').href = data.pdf_url;
                document.getElementById('badge-status').textContent = 'COMPLIANT';
                document.getElementById('badge-status').className = 'bg-emerald-500 text-white text-xs font-bold px-3 py-1 rounded-full flex items-center gap-1';

                // Health Claims
                const hcSection = document.getElementById('health-claims-section');
                if (data.health_claims) {
                    hcSection.style.display = 'block';
                    const qualTbody = document.getElementById('hc-qualified');
                    const disTbody = document.getElementById('hc-disqualified');
                    const hcNoClaims = document.getElementById('hc-no-claims');
                    const hcQualContainer = document.getElementById('hc-qualified-container');

                    qualTbody.innerHTML = '';
                    disTbody.innerHTML = '';

                    if (data.health_claims.qualified.length === 0) {
                        hcNoClaims.style.display = 'block';
                        hcQualContainer.style.display = 'none';
                    } else {
                        hcNoClaims.style.display = 'none';
                        hcQualContainer.style.display = 'block';
                        data.health_claims.qualified.forEach(q => {
                            qualTbody.innerHTML += `
                                <tr>
                                    <td class="px-6 py-4 font-semibold">${q.claim}</td>
                                    <td class="px-6 py-4 text-sm text-slate-600">${q.value}${q.unit}</td>
                                    <td class="px-6 py-4"><span class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-xs font-bold">ELIGIBLE</span></td>
                                </tr>`;
                        });
                    }

                    data.health_claims.disqualified.forEach(d => {
                        // Determine if value needs to go up or down
                        let direction = '';
                        let dirIcon = '';
                        if (d.claim.includes('High') || d.claim.includes('Source of')) {
                            direction = 'Increase by';
                            dirIcon = 'arrow_upward';
                        } else {
                            direction = 'Reduce by';
                            dirIcon = 'arrow_downward';
                        }
                        disTbody.innerHTML += `
                            <tr class="hover:bg-slate-50/50">
                                <td class="px-6 py-4">
                                    <div class="font-semibold text-slate-900">${d.claim}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <span class="bg-red-50 text-red-700 px-2.5 py-1 rounded-lg text-xs font-bold border border-red-200">
                                            Current: ${d.value}${d.unit}
                                        </span>
                                        <span class="material-symbols-outlined text-slate-400 text-lg">arrow_forward</span>
                                        <span class="bg-emerald-50 text-emerald-700 px-2.5 py-1 rounded-lg text-xs font-bold border border-emerald-200">
                                            Need: ${d.threshold}${d.unit}
                                        </span>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center gap-1 bg-amber-50 text-amber-800 px-2.5 py-1 rounded-lg text-xs font-bold border border-amber-200">
                                        <span class="material-symbols-outlined text-sm">${dirIcon}</span>
                                        ${direction} ${d.gap}${d.unit}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm text-slate-500 italic">${d.tip}</td>
                            </tr>`;
                    });
                } else {
                    hcSection.style.display = 'none';
                }

                // Sodium Fix
                const sfSection = document.getElementById('sodium-fix-section');
                if (data.sodium_fix) {
                    sfSection.style.display = 'block';
                    document.getElementById('sod-fix-current').textContent = data.sodium_fix.current_sodium_100g;
                    document.getElementById('sod-fix-excess').textContent = (data.sodium_fix.current_sodium_100g - 600).toFixed(1);

                    const sfContributors = document.getElementById('sod-fix-contributors');
                    sfContributors.innerHTML = '';
                    data.sodium_fix.contributors.forEach(c => {
                        sfContributors.innerHTML += `
                            <tr>
                                <td class="px-4 py-3 capitalize font-medium">${c.name}</td>
                                <td class="px-4 py-3 text-right">${c.contribution_mg.toFixed(1)}mg</td>
                                <td class="px-4 py-3 text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        ${c.percentage.toFixed(1)}%
                                        <div class="w-10 h-1 bg-slate-200 rounded-full overflow-hidden">
                                            <div class="h-full bg-red-500 rounded-full" style="width: ${c.percentage}%"></div>
                                        </div>
                                    </div>
                                </td>
                            </tr>`;
                    });

                    const sfCards = document.getElementById('sod-fix-cards');
                    sfCards.innerHTML = '';
                    let fixCount = 0;
                    data.sodium_fix.fixes.forEach(f => {
                        fixCount++;
                        let isLastCard = fixCount === data.sodium_fix.fixes.length;
                        let isFixed = isLastCard && data.sodium_fix.is_fully_fixed;
                        let borderColor = isFixed ? '#12af83' : '#3b82f6';
                        let badgeHtml = isFixed
                            ? `<span class="bg-emerald-500 text-white px-3 py-1 rounded-full text-xs font-bold">Fixed — ${f.sodium_removed}mg</span>`
                            : `<span class="bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-xs font-bold">Apply next fix too</span>`;

                        let tasteNote = f.is_primary ? `<p class="text-xs text-slate-400 italic mt-2">Reducing salt affects taste. Consider potassium chloride substitute.</p>` : '';

                        sfCards.innerHTML += `
                            <div class="border border-slate-200 rounded-lg p-4 mb-2" style="border-left: 4px solid ${borderColor}">
                                <div class="flex justify-between items-start mb-2">
                                    <strong class="capitalize">Fix: ${f.name}</strong>
                                    ${badgeHtml}
                                </div>
                                <div class="flex items-center gap-2 text-sm">
                                    Change from <span class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xs font-bold">${f.old_qty}g</span>
                                    →
                                    <span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full text-xs font-bold">${f.new_qty}g</span>
                                </div>
                                ${tasteNote}
                            </div>`;
                    });
                } else {
                    sfSection.style.display = 'none';
                }

            } catch (err) {
                errorBox.textContent = "Error: " + err.message;
                errorBox.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined">auto_awesome</span> Generate Nutrition Label';
                overlay.classList.remove('active');
            }
        }

        function toggleDetails() {
            const wrapper = document.getElementById('hc-disqualified-table-wrapper');
            const table = document.getElementById('hc-disqualified-table');
            const btn = document.getElementById('hc-toggle-btn');
            if (wrapper.style.display === 'none') {
                wrapper.style.display = 'block';
                table.style.display = 'table';
                btn.innerHTML = '<span class="material-symbols-outlined text-sm align-middle">expand_less</span> Hide Details';
            } else {
                wrapper.style.display = 'none';
                table.style.display = 'none';
                btn.innerHTML = '<span class="material-symbols-outlined text-sm align-middle">expand_more</span> Show Details';
            }
        }
    </script>
</head>

<body class="bg-background-light font-display text-slate-900 min-h-screen">
    <!-- Top Navigation Bar -->
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-primary/10 px-6 lg:px-20 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <a href="/" class="flex items-center gap-3 no-underline">
                <div class="bg-primary p-2 rounded-lg text-white">
                    <span class="material-symbols-outlined block">nutrition</span>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-slate-900">NutriComply</h1>
            </a>
            <nav class="hidden md:flex items-center gap-8">
                <a class="text-primary font-semibold flex items-center gap-2 no-underline" href="/dashboard">
                    <span class="material-symbols-outlined text-[20px]">dashboard</span> Dashboard
                </a>
                <a class="text-slate-500 hover:text-primary transition-colors font-medium no-underline"
                    href="/history">History</a>
                <a class="text-slate-500 hover:text-primary transition-colors font-medium no-underline"
                    href="/settings">Settings</a>
            </nav>
            <div class="flex items-center gap-4">
                {% if current_user and current_user.is_authenticated %}
                <a href="/logout"
                    class="hidden sm:flex items-center gap-2 px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-100 rounded-full transition-all no-underline">Logout</a>
                <div
                    class="size-10 rounded-full bg-primary/20 flex items-center justify-center text-primary font-bold border-2 border-primary/30">
                    {{ current_user.name[:2]|upper }}
                </div>
                {% endif %}
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-6 py-10 flex flex-col gap-6">
        <!-- Hero Header -->
        <div class="mb-4">
            <h2 class="text-4xl font-black tracking-tight flex items-center gap-3">
                <span class="text-primary">✦</span> Generate Nutrition Label
            </h2>
            <p class="text-slate-500 mt-2 text-lg">Create FSSAI-compliant labels from any recipe in seconds.</p>
        </div>

        <form onsubmit="generateLabel(event)">
            <!-- 1. Product Details Card -->
            <section class="bg-white p-6 rounded-xl border border-primary/10 shadow-sm mb-6">
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">inventory_2</span> Product Details
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700">Product Name</label>
                        <input
                            class="w-full rounded-xl border-slate-200 bg-slate-50 focus:ring-primary focus:border-primary transition-all"
                            name="product_name" placeholder="e.g. Organic Almond Butter" type="text" required />
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                            FSSAI License No.
                            <span
                                class="bg-primary/10 text-primary text-[10px] px-2 py-0.5 rounded font-bold border border-primary/20">Optional</span>
                        </label>
                        <input
                            class="w-full rounded-xl border-slate-200 bg-slate-50 focus:ring-primary focus:border-primary transition-all"
                            id="fssai_license" name="fssai_license"
                            placeholder="Enter 14-digit license number (optional)" type="text"
                            value="{{ settings.default_license or '' }}" />
                    </div>
                </div>
            </section>

            <!-- 2. Recipe Input Card -->
            <section class="bg-white p-6 rounded-xl border border-primary/10 shadow-sm mb-6">
                <div class="flex justify-between items-start mb-6">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">receipt_long</span> Recipe Input
                    </h3>
                    <span
                        class="bg-primary/10 text-primary text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest border border-primary/20">
                        Natural Language Supported
                    </span>
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-semibold text-slate-700">List of Ingredients (Include amounts)</label>
                    <textarea
                        class="w-full rounded-xl border-slate-200 bg-slate-50 focus:ring-primary focus:border-primary transition-all resize-none"
                        name="ingredients"
                        placeholder="Example: 500g roasted almonds, 2 tbsp honey, 1/2 tsp sea salt..." rows="6"
                        required></textarea>
                    <p class="text-xs text-slate-400 flex items-center gap-1">
                        <span class="material-symbols-outlined text-sm">info</span>
                        Tip: You can paste your entire recipe here; our AI will extract ingredients automatically.
                    </p>
                </div>
            </section>

            <!-- 3. Weight & Serving Card -->
            <section class="bg-white p-6 rounded-xl border border-primary/10 shadow-sm mb-6">
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">scale</span> Weight &amp; Serving
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700">Total Batch Yield (g/ml)</label>
                        <div class="relative">
                            <input
                                class="w-full rounded-xl border-slate-200 bg-slate-50 focus:ring-primary focus:border-primary transition-all pr-8"
                                name="total_weight" type="number" step="0.1" placeholder="e.g. 515" required />
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">g</span>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700">Net Weight per pack (g)</label>
                        <div class="relative">
                            <input
                                class="w-full rounded-xl border-slate-200 bg-slate-50 focus:ring-primary focus:border-primary transition-all pr-8"
                                name="net_weight" type="number" step="0.1" placeholder="e.g. 500" />
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">g</span>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700">Serving Size (g)</label>
                        <div class="relative">
                            <input
                                class="w-full rounded-xl border-slate-200 bg-slate-50 focus:ring-primary focus:border-primary transition-all pr-8"
                                name="serving_size" type="number" step="0.1" placeholder="32" required
                                value="{{ settings.default_serving_size if settings.default_serving_size else '' }}" />
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">g</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Error Message -->
            <div id="error-message"
                class="hidden mb-4 px-4 py-3 rounded-xl bg-red-50 border border-red-200 text-red-700 text-sm font-semibold"
                style="display: none;"></div>

            <!-- Action Button -->
            <button id="submitBtn" type="submit"
                class="w-full py-5 rounded-xl bg-gradient-to-r from-primary to-emerald-500 text-white font-black text-xl shadow-lg shadow-primary/20 hover:shadow-xl hover:scale-[1.01] transition-all flex items-center justify-center gap-3 mb-6">
                <span class="material-symbols-outlined">auto_awesome</span>
                Generate Nutrition Label
            </button>
        </form>

        <hr class="border-primary/10 my-2" />

        <!-- 4. Live Label Preview Card -->
        <section class="bg-white p-8 rounded-xl border border-primary/10 shadow-sm relative">
            <div id="loading-overlay">
                <svg aria-label="Hourglass loader" role="img" height="56px" width="56px" viewBox="0 0 56 56"
                    class="loader">
                    <clipPath id="sand-mound-top">
                        <path
                            d="M 14.613 13.087 C 15.814 12.059 19.3 8.039 20.3 6.539 C 21.5 4.789 21.5 2.039 21.5 2.039 L 3 2.039 C 3 2.039 3 4.789 4.2 6.539 C 5.2 8.039 8.686 12.059 9.887 13.087 C 11 14.039 12.25 14.039 12.25 14.039 C 12.25 14.039 13.5 14.039 14.613 13.087 Z"
                            class="loader__sand-mound-top" />
                    </clipPath>
                    <clipPath id="sand-mound-bottom">
                        <path
                            d="M 14.613 20.452 C 15.814 21.48 19.3 25.5 20.3 27 C 21.5 28.75 21.5 31.5 21.5 31.5 L 3 31.5 C 3 31.5 3 28.75 4.2 27 C 5.2 25.5 8.686 21.48 9.887 20.452 C 11 19.5 12.25 19.5 12.25 19.5 C 12.25 19.5 13.5 19.5 14.613 20.452 Z"
                            class="loader__sand-mound-bottom" />
                    </clipPath>
                    <g transform="translate(2,2)">
                        <g transform="rotate(-90,26,26)" stroke-linecap="round" stroke-dashoffset="153.94"
                            stroke-dasharray="153.94 153.94" stroke="hsl(0,0%,100%)" fill="none">
                            <circle transform="rotate(0,26,26)" r="24.5" cy="26" cx="26" stroke-width="2.5"
                                class="loader__motion-thick" />
                            <circle transform="rotate(90,26,26)" r="24.5" cy="26" cx="26" stroke-width="1.75"
                                class="loader__motion-medium" />
                            <circle transform="rotate(180,26,26)" r="24.5" cy="26" cx="26" stroke-width="1"
                                class="loader__motion-thin" />
                        </g>
                        <g transform="translate(13.75,9.25)" class="loader__model">
                            <path
                                d="M 1.5 2 L 23 2 C 23 2 22.5 8.5 19 12 C 16 15.5 13.5 13.5 13.5 16.75 C 13.5 20 16 18 19 21.5 C 22.5 25 23 31.5 23 31.5 L 1.5 31.5 C 1.5 31.5 2 25 5.5 21.5 C 8.5 18 11 20 11 16.75 C 11 13.5 8.5 15.5 5.5 12 C 2 8.5 1.5 2 1.5 2 Z"
                                fill="hsl(var(--hue),90%,85%)" />
                            <g stroke-linecap="round" stroke="hsl(35,90%,90%)">
                                <line y2="20.75" x2="12" y1="15.75" x1="12" stroke-dasharray="0.25 33.75"
                                    stroke-width="1" class="loader__sand-grain-left" />
                                <line y2="21.75" x2="12.5" y1="16.75" x1="12.5" stroke-dasharray="0.25 33.75"
                                    stroke-width="1" class="loader__sand-grain-right" />
                                <line y2="31.5" x2="12.25" y1="18" x1="12.25" stroke-dasharray="0.5 107.5"
                                    stroke-width="1" class="loader__sand-drop" />
                                <line y2="31.5" x2="12.25" y1="14.75" x1="12.25" stroke-dasharray="54 54"
                                    stroke-width="1.5" class="loader__sand-fill" />
                                <line y2="31.5" x2="12" y1="16" x1="12" stroke-dasharray="1 107" stroke-width="1"
                                    stroke="hsl(35,90%,83%)" class="loader__sand-line-left" />
                                <line y2="31.5" x2="12.5" y1="16" x1="12.5" stroke-dasharray="12 96" stroke-width="1"
                                    stroke="hsl(35,90%,83%)" class="loader__sand-line-right" />
                                <g stroke-width="0" fill="hsl(35,90%,90%)">
                                    <path
                                        d="M 12.25 15 L 15.392 13.486 C 21.737 11.168 22.5 2 22.5 2 L 2 2.013 C 2 2.013 2.753 11.046 9.009 13.438 L 12.25 15 Z"
                                        clip-path="url(#sand-mound-top)" />
                                    <path
                                        d="M 12.25 18.5 L 15.392 20.014 C 21.737 22.332 22.5 31.5 22.5 31.5 L 2 31.487 C 2 31.487 2.753 22.454 9.009 20.062 Z"
                                        clip-path="url(#sand-mound-bottom)" />
                                </g>
                            </g>
                            <g stroke-width="2" stroke-linecap="round" opacity="0.7" fill="none">
                                <path
                                    d="M 19.437 3.421 C 19.437 3.421 19.671 6.454 17.914 8.846 C 16.157 11.238 14.5 11.5 14.5 11.5"
                                    stroke="hsl(0,0%,100%)" class="loader__glare-top" />
                                <path transform="rotate(180,12.25,16.75)"
                                    d="M 19.437 3.421 C 19.437 3.421 19.671 6.454 17.914 8.846 C 16.157 11.238 14.5 11.5 14.5 11.5"
                                    stroke="hsla(0,0%,100%,0)" class="loader__glare-bottom" />
                            </g>
                            <rect height="2" width="24.5" fill="hsl(var(--hue),90%,50%)" />
                            <rect height="1" width="19.5" y="0.5" x="2.5" ry="0.5" rx="0.5"
                                fill="hsl(var(--hue),90%,57.5%)" />
                            <rect height="2" width="24.5" y="31.5" fill="hsl(var(--hue),90%,50%)" />
                            <rect height="1" width="19.5" y="32" x="2.5" ry="0.5" rx="0.5"
                                fill="hsl(var(--hue),90%,57.5%)" />
                        </g>
                    </g>
                </svg>
                <div class="loader-text">Generating your nutrition label…</div>
                <div class="loader-subtext">Parsing ingredients with AI</div>
            </div>

            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-black">Live Label Preview</h3>
                <div class="flex gap-2">
                    <span id="badge-status"
                        class="bg-slate-200 text-slate-600 text-xs font-bold px-3 py-1 rounded-full flex items-center gap-1">DRAFT</span>
                </div>
            </div>

            <!-- FSSAI Label Design -->
            <div class="max-w-md mx-auto border-4 border-slate-900 p-4 bg-white text-slate-900 font-sans">
                <h4 class="text-3xl font-black text-center mb-1 uppercase tracking-tighter">Nutrition Facts</h4>
                <div class="border-t-8 border-slate-900 mb-2"></div>
                <div class="flex justify-between text-sm mb-2 border-b-4 border-slate-900 pb-1">
                    <span class="font-bold">Serving Size</span>
                    <span><span id="res-size">--</span>g</span>
                </div>
                <div class="flex justify-between text-sm mb-2">
                    <span>Servings per container:</span>
                    <span id="res-servings">--</span>
                </div>

                <div id="sodium-warning" class="high-sodium">⚠ HIGH IN SODIUM</div>

                <table class="w-full text-sm leading-tight">
                    <thead>
                        <tr class="border-b-2 border-slate-900">
                            <th class="text-left py-1">Nutrients</th>
                            <th class="text-right py-1">Per 100g</th>
                            <th class="text-right py-1">Per Serve</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-300">
                        <tr>
                            <td class="py-1 font-bold">Energy (kcal)</td>
                            <td class="text-right" id="val-en-100">--</td>
                            <td class="text-right" id="val-en-serv">--</td>
                        </tr>
                        <tr>
                            <td class="py-1 font-bold">Protein (g)</td>
                            <td class="text-right" id="val-pro-100">--</td>
                            <td class="text-right" id="val-pro-serv">--</td>
                        </tr>
                        <tr>
                            <td class="py-1 font-bold">Total Fat (g)</td>
                            <td class="text-right" id="val-fat-100">--</td>
                            <td class="text-right" id="val-fat-serv">--</td>
                        </tr>
                        <tr>
                            <td class="py-1 pl-4 italic">Saturated Fat (g)</td>
                            <td class="text-right" id="val-sat-100">--</td>
                            <td class="text-right" id="val-sat-serv">--</td>
                        </tr>
                        <tr>
                            <td class="py-1 pl-4 italic">Trans Fat (g)</td>
                            <td class="text-right" id="val-trans-100">--</td>
                            <td class="text-right" id="val-trans-serv">--</td>
                        </tr>
                        <tr>
                            <td class="py-1 font-bold">Carbohydrates (g)</td>
                            <td class="text-right" id="val-carb-100">--</td>
                            <td class="text-right" id="val-carb-serv">--</td>
                        </tr>
                        <tr>
                            <td class="py-1 pl-4 italic">Total Sugars (g)</td>
                            <td class="text-right" id="val-sug-100">--</td>
                            <td class="text-right" id="val-sug-serv">--</td>
                        </tr>
                        <tr>
                            <td class="py-1 pl-8 italic text-slate-600">Added Sugars (g)</td>
                            <td class="text-right" id="val-addsug-100">--</td>
                            <td class="text-right" id="val-addsug-serv">--</td>
                        </tr>
                        <tr>
                            <td class="py-1 font-bold">Sodium (mg)</td>
                            <td class="text-right" id="val-sod-100">--</td>
                            <td class="text-right" id="val-sod-serv">--</td>
                        </tr>
                    </tbody>
                </table>

                <div class="border-t-4 border-slate-900 mt-2 pt-1 text-[10px] italic">
                    *Reference intake of an average adult (2000 kcal)
                </div>

                <div class="flex justify-between items-end border-t border-slate-300 pt-2 mt-3">
                    <div class="flex items-center gap-2">
                        <div id="veg-icon" class="veg-icon"></div>
                        <span id="veg-text" class="text-xs font-bold">Vegetarian</span>
                    </div>
                    <div class="text-right">
                        <div class="text-[8px] tracking-wider text-slate-500 uppercase">Allergen Information</div>
                        <div class="text-xs font-bold" id="res-allergen">--</div>
                    </div>
                </div>
            </div>

            <a href="#" id="download-pdf" target="_blank"
                class="w-full mt-8 bg-slate-900 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-slate-800 transition-colors no-underline">
                <span class="material-symbols-outlined">download</span> Download PDF Label
            </a>
        </section>

        <!-- 5. Sodium Fix Section -->
        <section id="sodium-fix-section" class="border-2 border-red-500 bg-red-50 p-6 rounded-xl shadow-sm"
            style="display: none;">
            <div class="flex items-center gap-3 text-red-600 mb-4">
                <span class="material-symbols-outlined font-bold">warning</span>
                <h3 class="text-lg font-black uppercase tracking-wide">High Sodium Warning</h3>
            </div>
            <div class="bg-white p-4 rounded-lg border border-red-200 mb-4 text-sm">
                <strong>Current Sodium:</strong> <span id="sod-fix-current"></span>mg/100g &bull;
                <strong>FSSAI Limit:</strong> 600mg/100g &bull;
                <strong class="text-red-600">Excess:</strong> <span id="sod-fix-excess"
                    class="text-red-600 font-bold"></span>mg
            </div>
            <div class="overflow-hidden border border-red-200 rounded-lg mb-4">
                <table class="w-full text-sm">
                    <thead class="bg-red-100">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-bold text-red-700 uppercase">Ingredient</th>
                            <th class="px-4 py-2 text-right text-xs font-bold text-red-700 uppercase">Contributed</th>
                            <th class="px-4 py-2 text-right text-xs font-bold text-red-700 uppercase">% of Total</th>
                        </tr>
                    </thead>
                    <tbody id="sod-fix-contributors" class="divide-y divide-red-100"></tbody>
                </table>
            </div>
            <div id="sod-fix-cards"></div>
        </section>

        <!-- 6. Health Claim Validator -->
        <section id="health-claims-section" class="bg-white p-6 rounded-xl border border-primary/10 shadow-sm"
            style="display: none;">
            <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">verified</span> Health Claim Validator
            </h3>

            <div id="hc-no-claims"
                class="bg-amber-50 border border-amber-200 text-amber-700 px-4 py-3 rounded-lg text-sm font-medium mb-4"
                style="display: none;">
                <strong>No Qualified Claims</strong> — This recipe does not currently meet any FSSAI health claim
                thresholds.
            </div>

            <div id="hc-qualified-container">
                <div class="overflow-hidden border border-slate-100 rounded-lg mb-4">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-3 text-xs font-black uppercase text-slate-500">Proposed Claim</th>
                                <th class="px-6 py-3 text-xs font-black uppercase text-slate-500">Your Value</th>
                                <th class="px-6 py-3 text-xs font-black uppercase text-slate-500">Status</th>
                            </tr>
                        </thead>
                        <tbody id="hc-qualified" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <button type="button" id="hc-toggle-btn" onclick="toggleDetails()"
                class="w-full py-3 border-2 border-slate-200 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-50 transition-colors flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-sm">expand_more</span> Show Details
            </button>

            <div class="overflow-hidden rounded-xl mt-4 border border-red-100" style="display: none;"
                id="hc-disqualified-table-wrapper">
                <div class="bg-red-50 px-6 py-3 border-b border-red-100 flex items-center gap-2">
                    <span class="material-symbols-outlined text-red-500 text-lg">block</span>
                    <span class="text-sm font-bold text-red-700">Not Yet Eligible — Here's what needs to change</span>
                </div>
                <table class="w-full text-left" id="hc-disqualified-table" style="display: none;">
                    <thead class="bg-red-50/50">
                        <tr>
                            <th class="px-6 py-3 text-xs font-black uppercase text-slate-600">Claim</th>
                            <th class="px-6 py-3 text-xs font-black uppercase text-slate-600">Current → Required</th>
                            <th class="px-6 py-3 text-xs font-black uppercase text-slate-600">Change Needed</th>
                            <th class="px-6 py-3 text-xs font-black uppercase text-slate-600">Tip</th>
                        </tr>
                    </thead>
                    <tbody id="hc-disqualified" class="divide-y divide-slate-100 bg-white"></tbody>
                </table>
            </div>
        </section>

        <!-- 7. Compliance Info Box -->
        <section class="bg-blue-50 p-6 rounded-xl border border-blue-100">
            <div class="flex gap-4">
                <span class="material-symbols-outlined text-blue-500">info</span>
                <div>
                    <h4 class="font-bold text-blue-900 mb-1">Data Source &amp; Accuracy</h4>
                    <p class="text-sm text-blue-700/80 leading-relaxed">
                        Nutritional calculations are based on the IFCT (Indian Food Composition Tables) 2017 and FSSAI
                        Food Safety Standards. Data is calculated using scientific yield factors and loss-of-water
                        coefficients. This tool provides a preliminary label; final testing at a NABL-certified lab is
                        recommended for commercial release.
                    </p>
                </div>
            </div>
        </section>

        <footer class="mt-10 mb-20 text-center text-slate-400 text-sm">
            <p>© 2026 NutriComply AI. All Rights Reserved. Built for FSSAI Compliance.</p>
        </footer>
    </main>
</body>

</html>